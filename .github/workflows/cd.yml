name: CD - Continuous Deployment

on:
  push:
    branches:
      - main
    tags:
      - 'v*'  # Trigger khi c√≥ tag v1.0.0, v2.1.0, etc.

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_BACKEND: ${{ github.repository }}-backend
  IMAGE_NAME_FRONTEND: ${{ github.repository }}-frontend

jobs:
  # Deploy to Staging (khi push v√†o main)
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && !startsWith(github.ref, 'refs/tags/')
    environment:
      name: staging
      url: https://staging.noitulienhoan.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: |
          cd backend && npm install
          cd ../frontend && npm install
      
      - name: Build backend
        working-directory: ./backend
        run: npm run build || echo "No build script"
      
      - name: Build frontend
        working-directory: ./frontend
        run: npm run build
      
      - name: Deploy to Staging Server
        run: |
          echo "üöÄ Deploying to Staging..."
          echo "Version: ${{ github.sha }}"
          echo "Branch: ${{ github.ref }}"
          # ·ªû ƒë√¢y b·∫°n s·∫Ω th√™m commands ƒë·ªÉ deploy
          # V√≠ d·ª•: rsync, scp, ho·∫∑c deployment scripts
          # rsync -avz --delete ./frontend/dist/ user@staging-server:/var/www/app/
          # ssh user@staging-server "cd /var/www/api && git pull && npm install && pm2 restart api"
      
      - name: Health Check
        run: |
          echo "‚úÖ Running health check on staging..."
          # curl -f https://staging.noitulienhoan.com/health || exit 1
          echo "Health check passed!"
      
      - name: Notify Deployment
        run: |
          echo "üì¢ Staging deployment completed!"
          echo "Deployed by: ${{ github.actor }}"
          echo "Commit: ${{ github.sha }}"

  # Build and Push Docker Images (khi c√≥ tag)
  build-and-push-images:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Extract metadata for backend
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}
          tags: |
            type=ref,event=tag
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest
      
      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Extract metadata for frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}
          tags: |
            type=ref,event=tag
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest
      
      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Image info
        run: |
          echo "‚úÖ Docker images built and pushed successfully!"
          echo "Backend: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:${{ steps.version.outputs.VERSION }}"
          echo "Frontend: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ steps.version.outputs.VERSION }}"

  # Deploy to Production (khi c√≥ tag)
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build-and-push-images
    if: startsWith(github.ref, 'refs/tags/v')
    environment:
      name: production
      url: https://noitulienhoan.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Deploy to Production Server
        run: |
          echo "üöÄ Deploying to Production..."
          echo "Version: ${{ steps.version.outputs.VERSION }}"
          echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:${{ steps.version.outputs.VERSION }}"
          
          # Deployment commands
          # V√≠ d·ª• v·ªõi Docker Swarm:
          # docker service update --image ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:${{ steps.version.outputs.VERSION }} api
          # docker service update --image ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ steps.version.outputs.VERSION }} frontend
          
          # V√≠ d·ª• v·ªõi Kubernetes:
          # kubectl set image deployment/backend backend=${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:${{ steps.version.outputs.VERSION }}
          # kubectl set image deployment/frontend frontend=${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:${{ steps.version.outputs.VERSION }}
          
          # V√≠ d·ª• v·ªõi Docker Compose tr√™n remote server:
          # ssh user@prod-server "cd /app && docker-compose pull && docker-compose up -d"
      
      - name: Database Migration
        run: |
          echo "üìä Running database migrations..."
          # ssh user@prod-server "cd /app && docker-compose exec -T backend npm run db:migrate"
          echo "Migrations completed!"
      
      - name: Smoke Tests
        run: |
          echo "üß™ Running smoke tests..."
          # curl -f https://noitulienhoan.com/health || exit 1
          # curl -f https://noitulienhoan.com/api/dictionary || exit 1
          echo "‚úÖ Smoke tests passed!"
      
      - name: Create deployment record
        run: |
          echo "üìù Creating deployment record..."
          echo "Version: ${{ steps.version.outputs.VERSION }}"
          echo "Deployed at: $(date)"
          echo "Deployed by: ${{ github.actor }}"
      
      - name: Notify success
        run: |
          echo "üéâ Production deployment successful!"
          echo "Version: ${{ steps.version.outputs.VERSION }}"
          # Send notification to Slack/Discord
          # curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} -H 'Content-Type: application/json' -d '{"text":"‚úÖ Deployed v${{ steps.version.outputs.VERSION }} to production"}'

  # Rollback deployment (manual trigger)
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    environment:
      name: production
    
    steps:
      - name: Rollback to previous version
        run: |
          echo "‚ö†Ô∏è Rolling back deployment..."
          # kubectl rollout undo deployment/backend
          # kubectl rollout undo deployment/frontend
          # Ho·∫∑c:
          # docker service rollback api
          # docker service rollback frontend
      
      - name: Verify rollback
        run: |
          echo "‚úÖ Rollback completed"
          # curl -f https://noitulienhoan.com/health || exit 1
          echo "Health check passed after rollback"
      
      - name: Notify rollback
        run: |
          echo "‚ö†Ô∏è Production rolled back!"
          echo "Triggered by: ${{ github.actor }}"

